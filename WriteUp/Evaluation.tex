\documentclass[12pt]{article}
\usepackage{amssymb,amsmath,latexsym, verbatim}
\usepackage{tikz,listings,url}
\usepackage{mathtools}
\usepackage{float}
\usepackage[margin=0.5in]{geometry}
%\usepackage{hyperref}
\usetikzlibrary{matrix,shapes,arrows,positioning,chains, calc}
\usepackage{array}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}

\lstset{basicstyle=\bfseries\small}

\newcommand{\nbar}{\overline{n}}
\newcommand{\mbar}{\overline{m}}

\begin{document}
\title{Evaluation of LWE Key Exchange Protocol}
\maketitle

\section{Asymptotics}
\begin{center}
    \begin{tabular}{| l | l |}
    \hline
Server work & $O(n^2\nbar)$\\ \hline
Client work & $O(n^2\mbar)$\\ \hline
Client downloads & $O(n \nbar)$\\ \hline
Client uploads & $O(n \mbar)$\\ \hline
    \end{tabular}
\end{center}

\section{First round of evaluations}
\subsection{ECDHE \tiny{(ECDHE-ECDSA-AES128-GCM-SHA256)}}

\begin{center}
    \begin{tabular}{| l | l | l |}
    \hline
    Curve & Client/Server keygen (ms) & Client/Server shared (ms) \\ \hline
    160 bit ecdh (secp160r1)  & 0.2   & 0.2 \\ \hline
    192 bit ecdh (nistp192)   & 0.2   & 0.2 \\ \hline
    224 bit ecdh (nistp224)   & 0.3   & 0.2 \\ \hline
    \textcolor{red}{256 bit ecdh (nistp256)}   & \textcolor{red}{0.3}   & \textcolor{red}{0.3} \\ \hline
    384 bit ecdh (nistp384)   & 1.2   & 0.6 \\ \hline
    521 bit ecdh (nistp521)   & 0.2   & 1.2 \\ \hline
    163 bit ecdh (nistk163)   & 0.2   & 0.2 \\ \hline
    233 bit ecdh (nistk233)   & 0.4   & 0.2 \\ \hline
    283 bit ecdh (nistk283)   & 0.6   & 0.4 \\ \hline
    409 bit ecdh (nistk409)   & 1.5   & 0.6 \\ \hline
    571 bit ecdh (nistk571)   & 0.2   & 1.5 \\ \hline
    163 bit ecdh (nistb163)   & 0.2   & 0.2 \\ \hline
    233 bit ecdh (nistb233)   & 0.4   & 0.2 \\ \hline
    283 bit ecdh (nistb283)   & 0.7   & 0.4 \\ \hline
    409 bit ecdh (nistb409)   & 1.6   & 0.7 \\ \hline
    571 bit ecdh (nistb571)   & 1.6   & 1.6 \\ \hline
    \end{tabular}
\end{center}

TSH protocol transcript:
\begin{center}
    \begin{tabular}{| l | l | l |}
    \hline
    $\leftarrow$ ClientHello & 158B & 0x009e\\ \hline
    $\rightarrow$ ServerHello & 66B & 0x0042\\ \hline
    $\rightarrow$ Certificate & 408B & 0x0198\\ \hline
    \textcolor{red}{$\rightarrow$ ServerKeyExchange} & \textcolor{red}{125B} & 0x007d\\ \hline
    $\rightarrow$ ServerHelloDone & 4B & 0x4\\ \hline
    \textcolor{red}{$\leftarrow$ ClientKeyExchange} & \textcolor{red}{70B} & 0x0046\\ \hline
    $\leftarrow$ ChangeCipherSpec & 1B & 0x1\\ \hline
    $\leftarrow$ Finished & 16B & 0x10\\ \hline
    $\rightarrow$ Session Ticket & 170B & 0x00aa\\ \hline
    $\rightarrow$ ChangeCipherSpec & 1B & 0x1\\ \hline
    $\rightarrow$ Finished & 16B & 0x10\\ \hline
    \end{tabular}
\end{center}

\subsection{RLWE \tiny{(RLWE-ECDSA-AES128-GCM-SHA256)}}

\footnotesize{\textbf{Keygen:} sampling $s(')$, $e(')$ and computing $b(') = as(') + e(')$\\
\textbf{Client shared:} sampling $e''$, computing $v = s'b + e''$, $c = \langle v \rangle_2$, $k = \lfloor v \rceil_2$\\
\textbf{Server shared:} computing $k = rec(b's, c)$}\\
\normalsize

RLWE (128 bits security, deriving 1024 bits key)
\begin{center}
    \begin{tabular}{| l | l | l |}
    \hline
    Client/Server keygen & Client shared & Server shared \\ \hline
    \textcolor{red}{0.674ms} & \textcolor{red}{0.402ms} & \textcolor{red}{0.119ms}  \\ \hline
    \end{tabular}
\end{center}

TSH protocol transcript:
\begin{center}
    \begin{tabular}{| l | l | l |}
    \hline
    $\leftarrow$ ClientHello & 158B & 0x009e\\ \hline
    $\rightarrow$ ServerHello & 66B & 0x0042\\ \hline
    $\rightarrow$ Certificate & 408B & 0x0198\\ \hline
    \textcolor{red}{$\rightarrow$ ServerKeyExchange} & \textcolor{red}{4154B = 4KiB} & 0x103a\\ \hline
    $\rightarrow$ ServerHelloDone & 4B & 0x4\\ \hline
    \textcolor{red}{$\leftarrow$ ClientKeyExchange} & \textcolor{red}{4232B = 4KiB} & 0x1088\\ \hline
    $\leftarrow$ ChangeCipherSpec & 1B & 0x1\\ \hline
    $\leftarrow$ Finished & 16B & 0x10\\ \hline
    $\rightarrow$ Session Ticket & 170B & 0x00aa\\ \hline
    $\rightarrow$ ChangeCipherSpec & 1B & 0x1\\ \hline
    $\rightarrow$ Finished & 16B & 0x10\\ \hline
    \end{tabular}
\end{center}

\subsection{LWE \tiny{(LWE-ECDSA-AES128-GCM-SHA256)}}

\footnotesize{\textbf{Server keygen:} sampling $S$, $E$ and computing $B = AS + E$\\
\textbf{Client keygen:} sampling $S'$, $E'$ and computing $B' = S'A + E'$\\
\textbf{Client shared:} sampling $E''$, computing $V = S'B + E''$, $C = \langle V \rangle_2$, $K = \lfloor V \rceil_2$\\
\textbf{Server shared:} computing $K = rec(B'S, C)$\\}
\normalsize

LWE (128 bits security, deriving $128 = \nbar \mbar$ bits key)
\begin{center}
    \begin{tabular}{| l | l | l | l |}
    \hline
    Server keygen & Client keygen & Client shared & Server shared \\ \hline
%    15.7ms & 29.5ms & 0.2ms & 0.1ms \\ \hline
%    \multicolumn{4}{c}{Store and use $A^T$ in generating client's key:} \\ \hline
    \textcolor{red}{15.9ms} &   \textcolor{red}{14.9ms} &   \textcolor{red}{0.147ms} &   \textcolor{red}{0.119ms} \\ \hline
    \end{tabular}
\end{center}

\footnotesize (*) Storing and using the $A^T$ matrix in generating client's key gives $2\times$ time improvement, otherwise Client keygen takes $\approx 29.5$ms.
\normalsize

About 20 X slowdown in key generation compared to RLWE, the rest is comparable.

% The experiment shows that

TSH protocol transcript:
\begin{center}
    \begin{tabular}{| l | l | l |}
    \hline
    $\leftarrow$ ClientHello & 158B & 0x009e\\ \hline
    $\rightarrow$ ServerHello & 66B & 0x0042\\ \hline
    $\rightarrow$ Certificate & 408B & 0x0198\\ \hline
    \textcolor{red}{$\rightarrow$ ServerKeyExchange} & \textcolor{red}{49209B = 48KiB} & 0xc039\\ \hline
    $\rightarrow$ ServerHelloDone & 4B & 0x4\\ \hline
    \textcolor{red}{$\leftarrow$ ClientKeyExchange} & \textcolor{red}{49176B = 48KiB} & 0xc018\\ \hline
    $\leftarrow$ ChangeCipherSpec & 1B & 0x1\\ \hline
    $\leftarrow$ Finished & 16B & 0x10\\ \hline
    $\rightarrow$ Session Ticket & 170B & 0x00aa\\ \hline
    $\rightarrow$ ChangeCipherSpec & 1B & 0x1\\ \hline
    $\rightarrow$ Finished & 16B & 0x10\\ \hline
    \end{tabular}
\end{center}

Time in key generation is split between sampling and matrix multiplication as 26\% and 74\%. So it make sense to optimize on matrix multiplication first.

\subsection{Better reconciliation mechanism}
See pencil notes, if $B$ bits are extracted from a single element in $Z_q$, then the probability for the two parties to fail the handshake (to end up with different keys) would be bounded from above by the following expression:
\begin{align*}
\mbar \cdot \nbar \cdot (4n) \exp\left(-\frac{q}{2^{3 + B} \cdot (2n) \sigma^2}\right)
\end{align*}

Since everything scales proportionally to $\mbar$ and $\nbar$, we can draw the following estimates (for now we assume $\nbar = \mbar$):
% formula used to calculate the exponent in the second column: (-2^(18 - i)/3.2/3.2 + ln(2^19 - i)) * log(e)
\begin{center}
    \begin{tabular}{|R{3cm}| R{3cm} | R{3cm} | R{3cm} | R{3cm} |}
    \hline
    Bits extracted from one ring element ($B$) & Probability of failure & $\nbar = \mbar = \sqrt{\frac{128}{B}}$ & Server/Client keygen (ms) & Client upload/download (KiB)\\ \hline
    1 & 1e-5553 & 12 & 16 & 48\\ \hline
    2 & 1e-2773 & 8 & 10 & 32\\ \hline
    3 & 1e-1384 & 7 & 9 & 28\\ \hline
    4 & 1e-689 & 6 & 8 & 24\\ \hline
    5 & 1e-341 & 5 & 6 & 20\\ \hline
    6 & 1e-167 & 5 & 6 & 20\\ \hline
    7 & 1e-81 & 5 & 6 & 20\\ \hline
    8 & 1e-37 & 4 & 5 & 16\\ \hline
    9 & 1e-15 & 4 & 5 & 16\\ \hline
    10 & 1e-5 & 4 & 5 & 16\\ \hline
    11 & 1e1 & 4 & 5 & 16\\ \hline
    \end{tabular}
\end{center}

% Trying out to extract 16bits, number of failed handshakes: .
Tried out $1048600 \approx 2^{20}$ key exchanges extracting 16 bits and 0 failed, so the bound can potentially be improved.

\end{document}
